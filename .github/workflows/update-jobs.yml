name: Update Jobs from Airtable

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fetch from Airtable and Save JSON
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          TABLE_NAME: 'Jobs'
        run: |
          python -c "
          import os, json, urllib.request, urllib.parse

          api_key = os.environ.get('AIRTABLE_API_KEY')
          base_id = os.environ.get('AIRTABLE_BASE_ID')
          table_name = os.environ.get('TABLE_NAME')

          if not api_key or not base_id:
              print('Error: Missing API Key or Base ID secrets.')
              exit(1)

          url = f'https://api.airtable.com/v0/{base_id}/{urllib.parse.quote(table_name)}'
          headers = {'Authorization': f'Bearer {api_key}'}

          try:
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  data = json.load(response)
                  
                  jobs = []
                  for record in data.get('records', []):
                      fields = record.get('fields', {})
                      
                      # --- SMART MAPPING START ---
                      # Try multiple common names for each field
                      title = fields.get('Job Title') or fields.get('Title') or fields.get('Name') or 'Untitled Role'
                      company = fields.get('Company') or fields.get('Company Name') or 'Unknown Company'
                      location = fields.get('Location') or fields.get('City') or 'Remote'
                      job_type = fields.get('Job Type') or fields.get('Type') or 'Full-time'
                      salary = fields.get('Salary Range') or fields.get('Salary') or ''
                      link = fields.get('Apply Link') or fields.get('Link') or fields.get('URL') or '#'
                      tags = fields.get('Tags') or []
                      # --- SMART MAPPING END ---

                      job = {
                          'id': record.get('id'),
                          'title': title,
                          'company': company,
                          'location': location,
                          'type': job_type,
                          'salary': salary,
                          'url': link,
                          'tags': tags,
                          'date': record.get('createdTime', '')
                      }
                      jobs.append(job)

                  if not os.path.exists('data'):
                      os.makedirs('data')

                  with open('data/jobs.json', 'w') as f:
                      json.dump(jobs, f, indent=2)
                  
                  print(f'Success! Fetched {len(jobs)} jobs.')

          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add data/jobs.json
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update jobs with smart column mapping"
            git push
          fi
