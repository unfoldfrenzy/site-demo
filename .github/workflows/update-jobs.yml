name: Update Jobs from Airtable

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fetch from Airtable and Save JSON
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          TABLE_NAME: 'Jobs' # <--- MAKE SURE YOUR AIRTABLE TAB IS NAMED THIS
        run: |
          python -c "
          import os, json, urllib.request, urllib.error

          api_key = os.environ.get('AIRTABLE_API_KEY')
          base_id = os.environ.get('AIRTABLE_BASE_ID')
          table_name = os.environ.get('TABLE_NAME')

          if not api_key or not base_id:
              print('Error: Missing API Key or Base ID secrets.')
              exit(1)

          # Encoded table name to handle spaces if needed
          url = f'https://api.airtable.com/v0/{base_id}/{urllib.parse.quote(table_name)}'
          headers = {'Authorization': f'Bearer {api_key}'}

          try:
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as response:
                  data = json.load(response)
                  
                  # Process records
                  jobs = []
                  for record in data.get('records', []):
                      fields = record.get('fields', {})
                      # Map Airtable fields to Website keys (lowercase)
                      job = {
                          'id': record.get('id'),
                          'title': fields.get('Job Title', 'Untitled'),
                          'company': fields.get('Company', 'Unknown'),
                          'location': fields.get('Location', 'Remote'),
                          'type': fields.get('Job Type', 'Full-time'),
                          'salary': fields.get('Salary Range', ''),
                          'url': fields.get('Apply Link', '#'),
                          'tags': fields.get('Tags', []),
                          'date': record.get('createdTime', '')
                      }
                      jobs.append(job)

                  # Ensure data directory exists
                  if not os.path.exists('data'):
                      os.makedirs('data')

                  # Save to file
                  with open('data/jobs.json', 'w') as f:
                      json.dump(jobs, f, indent=2)
                  
                  print(f'Success! Fetched {len(jobs)} jobs.')

          except urllib.error.HTTPError as e:
              print(f'HTTP Error: {e.code} {e.reason}')
              print(e.read().decode('utf-8')) # Print the actual error from Airtable
              exit(1)
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          git add data/jobs.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update jobs from Airtable"
            git push
          fi
