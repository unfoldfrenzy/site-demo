name: Update Vendors & Track Changes

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download CSV
        env:
          CSV_URL: ${{ secrets.SHEET_CSV_URL }}
        run: |
          curl -L "$CSV_URL" -o vendors.csv

      - name: Process Data and Log Changes
        shell: python
        run: |
          import csv
          import json
          import sys
          import os
          from datetime import date

          # --- CONFIGURATION ---
          VENDORS_FILE = 'data/vendors.json'
          CHANGELOG_FILE = 'data/changelog.json'
          
          # MAPPING: 'CSV Header Name': 'JSON Key Name'
          # These MUST match the headers in your Google Sheet Image exactly
          MAPPING = {
              'Name': 'Name',
              'Plan Name': 'Plan Name',
              'Price (₹/mo)': 'Price (₹/mo)',
              'Limits (Users etc.)': 'Limits (Users etc.)',
              'Key Features': 'Key Features',
              'Source URL': 'Source URL',
              'Last Updated': 'Last Updated'
          }
          # ---------------------

          # 1. LOAD OLD DATA (Snapshot state before update)
          old_vendors = []
          if os.path.exists(VENDORS_FILE):
              try:
                  with open(VENDORS_FILE, 'r', encoding='utf-8') as f:
                      old_vendors = json.load(f)
              except:
                  pass

          # 2. PARSE NEW DATA (From CSV)
          new_vendors = []
          if not os.path.exists('vendors.csv'):
              print("Error: CSV not found")
              sys.exit(1)

          try:
              with open('vendors.csv', 'r', encoding='utf-8') as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      item = {}
                      for csv_key, json_key in MAPPING.items():
                          # use .strip() to clean accidental spaces in sheet cells
                          item[json_key] = row.get(csv_key, '').strip()
                      
                      # Only add if it has a Name
                      if item.get('Name'):
                          new_vendors.append(item)
          except Exception as e:
              print(f"Error parsing CSV: {e}")
              sys.exit(1)

          # 3. COMPARE & TRACK CHANGES
          # Convert list to dict for fast lookup using the new 'Name' key
          old_dict = {}
          for item in old_vendors:
              if 'Name' in item:
                  old_dict[item['Name']] = item
          
          changes = []
          
          for new_item in new_vendors:
              name = new_item['Name']
              
              if name in old_dict:
                  old_item = old_dict[name]
                  
                  # Check Price Change
                  # Keys must match the MAPPING above exactly
                  new_price = new_item.get('Price (₹/mo)', '')
                  old_price = old_item.get('Price (₹/mo)', '')

                  if new_price != old_price:
                      changes.append({
                          "date": str(date.today()),
                          "vendor": name,
                          "type": "Price Change",
                          "details": f"Price changed from {old_price} to {new_price}"
                      })
                  
                  # Check Feature Update
                  new_desc = new_item.get('Key Features', '')
                  old_desc = old_item.get('Key Features', '')

                  if new_desc != old_desc:
                        changes.append({
                           "date": str(date.today()),
                           "vendor": name,
                           "type": "Plan Update",
                           "details": "Key Features updated."
                       })
              else:
                  # New Vendor Found
                  changes.append({
                      "date": str(date.today()),
                      "vendor": name,
                      "type": "New Vendor",
                      "details": "Vendor added to benchmark."
                  })

          # 4. SAVE VENDORS (Overwrite with new data)
          if not os.path.exists('data'):
              os.makedirs('data')
              
          with open(VENDORS_FILE, 'w', encoding='utf-8') as f:
              json.dump(new_vendors, f, indent=2)
          print(f"Saved {len(new_vendors)} vendors.")

          # 5. SAVE CHANGELOG (Prepend new changes)
          if changes:
              history = []
              if os.path.exists(CHANGELOG_FILE):
                  try:
                      with open(CHANGELOG_FILE, 'r', encoding='utf-8') as f:
                          history = json.load(f)
                  except:
                      pass
              
              # Add new changes to the TOP
              updated_history = changes + history
              
              with open(CHANGELOG_FILE, 'w', encoding='utf-8') as f:
                  json.dump(updated_history, f, indent=2)
              
              print(f"✅ Logged {len(changes)} new changes.")
          else:
              print("No changes detected.")

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # Add both files
          git add data/vendors.json data/changelog.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update vendor data and changelog"
            git push
          fi
