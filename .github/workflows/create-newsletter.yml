name: Weekly Newsletter Draft

on:
  schedule:
    - cron: '0 14 * * 1' # Runs every Monday at 2 PM UTC
  workflow_dispatch:      # Allows manual trigger for testing

jobs:
  draft-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Create Beehiiv Draft
        env:
          BEEHIIV_API_KEY: ${{ secrets.BEEHIIV_API_KEY }}
          BEEHIIV_PUB_ID: ${{ secrets.BEEHIIV_PUBLICATION_ID }}
        run: |
          python -c "
          import os, json, requests, datetime

          api_key = os.environ.get('BEEHIIV_API_KEY')
          pub_id = os.environ.get('BEEHIIV_PUB_ID')

          if not api_key or not pub_id:
              print('Skipping: Missing Beehiiv API Key or Publication ID.')
              exit(0)

          # 1. Load Data
          try:
              with open('data/jobs.json', 'r') as f:
                  jobs = json.load(f)
              with open('data/vendors.json', 'r') as f:
                  vendors = json.load(f)
          except:
              print('Error loading data files.')
              jobs = []
              vendors = []

          # 2. Filter for 'New' items (Simulated for Demo: Taking last 3)
          # In a real scenario, you would check dates (e.g., job['date'] > last_week)
          new_jobs = jobs[:3] 
          new_vendors = vendors[:2]

          # 3. Build HTML Content
          html_content = '<h2>üöÄ New Updates this Week</h2><p>Here are the latest changes in the Payroll SaaS market.</p>'
          
          if new_vendors:
              html_content += '<h3>üÜï Vendor Updates</h3><ul>'
              for v in new_vendors:
                  name = v.get('name') or v.get('Name') or 'Unknown'
                  price = v.get('price') or v.get('Pricing') or ''
                  html_content += f'<li><strong>{name}</strong>: {price}</li>'
              html_content += '</ul>'

          if new_jobs:
              html_content += '<h3>üíº Fresh Jobs</h3><ul>'
              for j in new_jobs:
                  title = j.get('title') or 'Role'
                  company = j.get('company') or 'Company'
                  link = j.get('url') or '#'
                  html_content += f'<li><a href=\"{link}\">{title}</a> at {company}</li>'
              html_content += '</ul>'

          html_content += '<p>See all updates on our <a href=\"https://unfoldfrenzy.github.io/site-demo/\">Live Dashboard</a>.</p>'

          # 4. Send to Beehiiv
          url = f'https://api.beehiiv.com/v2/publications/{pub_id}/posts'
          headers = {
              'Authorization': f'Bearer {api_key}',
              'Content-Type': 'application/json'
          }
          # --- DYNAMIC TAG LOGIC ---
          my_tags = ['weekly-update']
          if new_jobs:
              my_tags.append('jobs')
          if new_vendors:
              my_tags.append('vendor-updates')
          # -------------------------

          payload = {
              'title': f'Payroll Intelligence: Weekly Update {datetime.date.today()}',
              'subtitle': 'Latest jobs and pricing changes.',
              'status': 'draft',
              'content_tags': my_tags,  # Uses the list we built above
              'body_html': html_content
          }

          response = requests.post(url, json=payload, headers=headers)
          
          if response.status_code in [200, 201]:
              print('‚úÖ Success! Draft created in Beehiiv.')
          else:
              print(f'‚ùå Error: {response.status_code}')
              print(response.text)
          "
